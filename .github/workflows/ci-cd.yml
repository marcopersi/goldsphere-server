name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  BUN_VERSION: '1.3.4'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true
      - name: Install Dependencies
        run: bun install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      - name: Run ESLint
        run: bun run lint
      - name: Run type checking
        run: bunx tsc --noEmit

  jscpd:
    name: Copy-Paste Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true
      - name: Run jscpd copy-paste detection
        run: |
          mkdir -p reports/jscpd
          bunx jscpd --config .jscpd.json
      - name: Generate HTML Report
        if: always()
        run: bun scripts/jscpd-html-report.mjs
      - name: Upload jscpd report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jscpd-report
          path: reports/jscpd/
          retention-days: 30

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true
      - name: Install Dependencies
        run: bun install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      - name: Build
        run: bun run build
        env:
          CI: false
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist        

  test:
      name: Test (Unit)
      runs-on: ubuntu-latest
      needs: [build, lint, jscpd]
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v4
        - name: Set up Bun
          uses: oven-sh/setup-bun@v1
          with:
            bun-version: ${{ env.BUN_VERSION }}
            cache: true
        - name: Install Dependencies
          run: bun install
          env:
            NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        - name: Run unit tests
          run: bun run test:ci
          env:
            NODE_ENV: test
            JWT_SECRET: test-jwt-secret-key-for-ci-testing-only
            API_DOCS_ENABLED: false
        - name: Upload coverage to Codecov
          if: success()
          uses: codecov/codecov-action@v4
          with:
            file: ./coverage/lcov.info
            flags: unittests
            name: codecov-umbrella

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true
      - name: Install Dependencies
        run: bun install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      - name: Run semantic-release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 24
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [release]
    if: needs.release.outputs.new_release_published == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/goldsphere-server
          tags: |
            type=raw,value=${{ needs.release.outputs.new_release_version }}
            type=raw,value=latest
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_AUTH_TOKEN=${{ secrets.NODE_AUTH_TOKEN }}
      
      - name: Test Docker Image
        run: |
          docker run --rm ghcr.io/${{ github.repository_owner }}/goldsphere-server:latest node --version
          echo "âœ… Docker image built successfully and can execute Node.js"


